<div class="form-editor-container container-fluid vh-100 d-flex flex-column p-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3">
      <button class="btn btn-outline-secondary" (click)="goBack()">← Retour</button>
      <h3 class="mb-0">{{ isEditMode ? 'Modifier' : 'Créer' }} un formulaire</h3>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-primary" (click)="togglePreview()" [disabled]="saving"
        title="Basculer entre édition et aperçu">
        <i [class]="showPreview ? 'bi bi-pencil' : 'bi bi-eye'"></i>
        {{ showPreview ? 'Éditer' : 'Aperçu' }}
      </button>
      <button class="btn btn-secondary" (click)="saveDraft()" [disabled]="saving"
        title="Enregistrer le formulaire en brouillon">
        <i [class]="saving ? 'bi bi-hourglass-split' : 'bi bi-save'"></i>
        {{ saving ? 'Enregistrement...' : 'Enregistrer' }}
      </button>

      <button class="btn btn-success" (click)="saveAndPublish()" [disabled]="saving"
              title="Publier le formulaire">
        <i [class]="saving ? 'bi bi-hourglass-split' : 'bi bi-clipboard2-check'"></i>
        {{ saving ? 'Publication...' : 'Publier' }}
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="position-relative text-center flex-grow-1 d-flex flex-column justify-content-center align-items-center">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 fw-semibold">Chargement...</p>
  </div>

  <!-- Editor + Sidebar -->
  <div *ngIf="!loading && !showPreview" class="d-flex flex-grow-1 gap-3 overflow-hidden">

    <!-- Sidebar -->
    <div class="sidebar bg-light border rounded p-3 flex-shrink-0" style="width: 220px; overflow-y: auto;">
      <h5><i class="bi bi-lightbulb"></i> Types de champ</h5>
      <p class="text-muted small mb-2">Cliquez pour insérer un template</p>

      <div class="d-grid gap-2 mb-4">
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('text')">
          <i class="bi bi-input-cursor-text me-1"></i>Texte court
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('comment')">
          <i class="bi bi-text-paragraph me-1"></i>Texte long
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('dropdown')">
          <i class="bi bi-menu-down me-1"></i>Liste déroulante
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('checkbox')">
          <i class="bi bi-check2-square me-1"></i>Cases à cocher
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('radiogroup')">
          <i class="bi bi-ui-radios me-1"></i>Choix unique
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('rating')">
          <i class="bi bi-star me-1"></i>Notation
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('boolean')">
          <i class="bi bi-toggle-on me-1"></i>Oui/Non
        </button>
        <button class="btn btn-outline-primary btn-sm" (click)="insertTemplate('file')">
          <i class="bi bi-file-earmark me-1"></i>Fichier
        </button>
      </div>

      <div class="help-section mt-auto pt-5">
        <h5><i class="bi bi-journal-text"></i> Documentation</h5>
        <a href="https://surveyjs.io/form-library/documentation/api-reference/survey-data-model" target="_blank">
          Lien SurveyJS API
        </a>
      </div>
    </div>

    <!-- Editor -->
    <div class="editor flex-grow-1 d-flex flex-column h-100 overflow-hidden">
      <div class="card shadow-sm h-100 d-flex flex-column p-3 overflow-hidden">

        <div class="mb-2">
          <h5>Éditeur JSON</h5>
          <p class="text-muted small mb-1">Modifiez le JSON pour créer votre formulaire</p>
        </div>

        <div *ngIf="jsonError" class="alert alert-danger py-2 mb-2">
          <i class="bi bi-radioactive"></i> {{ jsonError }}
        </div>

        <textarea
          id="jsonEditor"
          [(ngModel)]="jsonSchema"
          (ngModelChange)="validateJSON()"
          class="form-control flex-grow-1 mb-2"
          spellcheck="false"
          style="resize: none; overflow-y: auto;"
        ></textarea>

        <small class="text-muted">
          <i class="bi bi-lightbulb"></i> Astuce : Utilisez les boutons à gauche pour insérer des templates de questions.
        </small>
      </div>
    </div>

  </div>

  <!-- Preview Mode -->
  <div *ngIf="!loading && showPreview" class="card shadow-sm p-3 flex-grow-1 overflow-auto text-center">
    <div class="alert alert-warning alert-dismissible fade show">
      <div class="mb-0">
        <h5 class="alert-heading">Aperçu du formulaire</h5>
        <p class="text-muted small mb-0">Voici comment les utilisateurs verront votre formulaire</p>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div *ngIf="previewSurvey" class="overflow-auto">
      <survey [model]="previewSurvey"></survey>
    </div>
  </div>

</div>
